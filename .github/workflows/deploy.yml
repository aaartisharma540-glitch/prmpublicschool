name: Deploy to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Configure Vite base for Pages
        run: |
          if [[ "$GITHUB_REPOSITORY" == *".github.io" ]]; then
            echo "VITE_BASE=/" >> $GITHUB_ENV
          else
            REPO_NAME="${GITHUB_REPOSITORY#*/}"
            echo "VITE_BASE=/${REPO_NAME}/" >> $GITHUB_ENV
          fi
      - name: Build
        run: npm run build
      - name: Setup Pages
        uses: actions/configure-pages@v4
      - name: Upload artifact (unique per run)
        uses: actions/upload-pages-artifact@v3
        with:
          # Use a run-unique name to avoid conflicts when multiple artifacts exist
          name: github-pages-${{ github.run_id }}
          path: './dist'
      - name: Deduplicate github-pages artifacts (keep newest)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_ID: ${{ github.run_id }}
          REPO: ${{ github.repository }}
          EXPECTED_NAME: github-pages-${{ github.run_id }}
        run: |
          echo "Listing artifacts for run $RUN_ID"
          sudo apt-get update && sudo apt-get install -y jq
          response=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID/artifacts")
          echo "$response" | jq '.artifacts[] | {name: .name, id: .id}'

          # Find artifact IDs with the exact expected name
          ids=( $(echo "$response" | jq -r --arg N "$EXPECTED_NAME" '.artifacts[] | select(.name == $N) | .id') )
          count=${#ids[@]}
          echo "Found $count artifacts named $EXPECTED_NAME in this run"

          if [ "$count" -le 1 ]; then
            echo "No duplicates to remove."
            exit 0
          fi

          # Keep the newest artifact (highest numeric id) and delete the rest
          keep=$(printf '%s\n' "${ids[@]}" | sort -n | tail -n1)
          echo "Keeping artifact id: $keep"
          for id in "${ids[@]}"; do
            if [ "$id" != "$keep" ]; then
              echo "Deleting artifact id: $id"
              status=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE -H "Authorization: Bearer $GITHUB_TOKEN" "https://api.github.com/repos/$REPO/actions/artifacts/$id")
              echo "Delete HTTP status: $status"
            fi
          done

          # Re-check count
          response=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID/artifacts")
          count=$(echo "$response" | jq '[.artifacts[] | select(.name == "'"$EXPECTED_NAME"'")] | length')
          echo "After dedupe, $count artifact(s) named $EXPECTED_NAME remain"
          if [ "$count" -ne 1 ]; then
            echo "Error: expected exactly 1 artifact after dedupe, found $count"
            echo "$response" | jq '.artifacts[] | {name: .name, id: .id}'
            exit 1
          fi
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_name: github-pages-${{ github.run_id }}